version: "3.8"

services:
  quilt-server:
    build: 
      context: .
      args:
        MINECRAFT_VERSION: "1.20.1"
    volumes:
      # Needs Z on Fedora because of SELinux, see 
      # <https://docs.podman.io/en/latest/markdown/podman-run.1.html#volume-v-source-volume-host-dir-container-dir-options>
      # Labeling Volume Mounts
      - ./data:/data:Z
      # W^X (write xor execute): mount mods as *read-only*, can only be added
      # to from outside the container
      - ./mods:/data/mods:ro,Z
      # W^X is incomplete because the libraries and versions folders are W&X
      # They need to be generated by the server *and* be in the data folder
      # So either
      #   - we leave the libraries/versions folders in the read-only image in
      #     the data folder, and bind mount each individual file from the host
      #     to the data folder. This means we have to provide each file and
      #     define their default values, because we can't copy them to the host
      #     during the build, or...
      #   - allow the libraries/versions folders to be W&X.
      # Taking the second option for now, at least the mods folder is protected
    ports:
      # Open default port for minecraft server
      - "25565:25565"
    # Allow us to attach to the container later
    stdin_open: true
    tty: true

    # Protect our entry jar from modification
    read_only: true

    # Java writes and executes from /tmp
    tmpfs:
        - /tmp:size=10M,mode=0770,nosuid,nodev

    # limit the resources that can be used!
    deploy:
      resources:
        limits:
          cpus: 6
          memory: 4g
          pids: 256

    # Drop all capabilities since we don't need them!
    cap_drop:
      - ALL
